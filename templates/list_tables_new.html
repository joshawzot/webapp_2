{% extends "base.html" %}

{% block title %}List of Tables from Multiple Databases{% endblock %}

{% block content %}
<div class="container">
    <div class="mt-3 mb-3">
        <button class="btn btn-primary" id="selectAll">Select All</button>
        <button class="btn btn-secondary" id="deselectAll">Deselect All</button>
        <button class="btn btn-danger" id="deleteSelected">Delete Selected</button>
        <button class="btn btn-info" id="plotSelected">Plot Selected</button>
    </div>

    <!-- Drag and Drop File Upload Area with Database Selection -->
    <div class="border p-3 mb-4">
        <h3>Upload Files to Selected Database:</h3>
        <form id="uploadForm" action="/upload-file" method="post" enctype="multipart/form-data" class="mb-3">
            <!-- Dropdown to select the database -->
            <div class="form-group mb-3">
                <label for="databaseSelect">Choose Database:</label>
                <select class="form-control" id="databaseSelect" name="database">
                    {% for db in databases %}
                    <option value="{{ db }}">{{ db }}</option>
                    {% endfor %}
                </select>
            </div>
            <input type="file" name="files[]" id="files" multiple accept=".csv,.txt" style="display: none;">
            <div id="drop_area" class="drag-drop-area">
                <p>Drag and drop files here</p>
                <p>or click to select files</p>
            </div>
            <div id="file_list" class="file-list">
                <p>No files selected</p>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>

    {% for db_name, tables in db_tables.items() %}
        <h4>Tables in {{ db_name }}: {{ tables|length }}</h4>
        <ul id="table-list-{{ db_name }}" class="list-group no-bullets">
            {% for table in tables %}
                <li data-table-name="{{ table['table_name'] }}" data-database-name="{{ db_name }}" class="table-item">
                    <input type="checkbox" id="select-table-{{ loop.index }}" class="table-checkbox" data-table-name="{{ table['table_name'] }}" data-database-name="{{ db_name }}">
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='{{ url_for('view_table', database=db_name, table_name=table['table_name']) }}'">View</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('{{ db_name }}', '{{ table['table_name'] }}')">Delete This Table</button>
                    <span>{{ table['table_name'] }}</span>
                </li>
            {% endfor %}
        </ul>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var dropArea = document.getElementById('drop_area');
    var fileInput = document.getElementById('files');
    var uploadForm = document.getElementById('uploadForm');
    var accumulatedFiles = [];

    function setupDragAndDrop() {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        dropArea.addEventListener('drop', function(e) {
            var files = e.dataTransfer.files;
            handleFiles(files);
        });

        // Click event to trigger file selection dialog
        dropArea.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitFiles();
        });
    }

    function handleFiles(files) {
        accumulatedFiles = accumulatedFiles.concat(Array.from(files));
        updateFileList();
    }

    function updateFileList() {
        var fileListElement = document.getElementById('file_list');
        fileListElement.innerHTML = '';
        if (accumulatedFiles.length > 0) {
            var list = document.createElement('ul');
            accumulatedFiles.forEach(function(file, index) {
                var listItem = document.createElement('li');
                listItem.textContent = `${index + 1}: ${file.name}`;
                list.appendChild(listItem);
            });
            fileListElement.appendChild(list);
        } else {
            fileListElement.innerHTML = '<p>No files selected</p>';
        }
    }

    function fetchAndUpdateTables(dbName) {
    fetch(`/get-tables/${dbName}`)
        .then(response => response.json())
        .then(data => {
            const tables = data.tables;
            const tableListElement = document.getElementById(`table-list-${dbName}`);
            tableListElement.innerHTML = '';  // Clear existing table list

            tables.forEach((table, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'table-item';
                listItem.innerHTML = `
                    <input type="checkbox" class="table-checkbox" data-table-name="${table.table_name}" data-database-name="${dbName}">
                    <button class="btn btn-primary btn-sm" onclick="window.location.href='{{ url_for('view_table', database='${dbName}', table_name='${table.table_name}') }}'">View</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord('${dbName}', '${table.table_name}')">Delete This Table</button>
                    <span>${table.table_name}</span>
                `;
                tableListElement.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error fetching tables:', error));
}

function submitFiles() {
    var formData = new FormData(uploadForm);
    accumulatedFiles.forEach(function(file) {
        formData.append('files[]', file);
    });
    formData.append('db_name', document.getElementById('databaseSelect').value);

    fetch(uploadForm.action, {
        method: 'POST',
        body: formData,
    }).then(response => response.json()).then(data => {
        console.log('Response received:', data);
        if (data.results) {
            alert('Response: ' + data.results.join('\n'));
            accumulatedFiles = [];
            updateFileList();
            const dbName = document.getElementById('databaseSelect').value;
            fetchAndUpdateTables(dbName);  // Fetch and update the table list
        }
    }).catch(error => {
        console.error('Error uploading files:', error);
        alert('Error uploading files: ' + error.message);
    });
}

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        dropArea.classList.add('highlight');
    }

    function unhighlight(e) {
        dropArea.classList.remove('highlight');
    }

    setupDragAndDrop();
});

    document.getElementById('selectAll').addEventListener('click', function() {
        document.querySelectorAll('.table-checkbox').forEach(checkbox => checkbox.checked = true);
    });

    document.getElementById('deselectAll').addEventListener('click', function() {
        document.querySelectorAll('.table-checkbox').forEach(checkbox => checkbox.checked = false);
    });

    document.getElementById('deleteSelected').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.table-checkbox:checked');
        let tableRecords = [];

        checkboxes.forEach(function(checkbox) {
            tableRecords.push({
                database: checkbox.getAttribute('data-database-name'),
                tableName: checkbox.getAttribute('data-table-name')
            });
        });

        // Implement delete logic here, possibly calling server-side with fetch API
        console.log('Delete these tables:', tableRecords);
    });

    document.getElementById('plotSelected').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.table-checkbox:checked');
        let tableIdentifiers = [];
        
        checkboxes.forEach(function(checkbox) {
            let dbName = checkbox.getAttribute('data-database-name');
            let tableName = checkbox.getAttribute('data-table-name');
            tableIdentifiers.push(dbName + '.' + tableName); // Combine database and table name
        });
        
        if (tableIdentifiers.length > 0) {
            let baseUrl = "{{ url_for('view_plot_multi_database', plot_function='plot_function') }}";
            baseUrl += '?tables=' + encodeURIComponent(tableIdentifiers.join(',')); // Append tables as a query parameter
            
            window.location.href = baseUrl;
        } else {
            alert('Please select at least one table to plot.');
        }
    });
</script>

<style>
.drag-drop-area {
    border: 2px dashed #007bff;
    border-radius: 5px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    margin-top: 20px;
}

.drag-drop-area:hover {
    background-color: #f8f9fa;
}

.file-list ul {
    list-style-type: none;
    padding: 0;
}

.file-list p {
    margin-top: 10px;
}

.highlight {
    background-color: #f0f0f0;
}

    .no-bullets {
        list-style-type: none; /* Removes the bullets */
        padding-left: 0; /* Removes the padding which is also part of the default list style */
    }
    .drag-drop-area {
        border: 2px dashed #007bff;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        margin-top: 20px;
    }
    .drag-drop-area:hover {
        background-color: #f8f9fa;
    }
    .file-list ul {
        list-style-type: none;
        padding: 0;
    }
    .file-list p {
        margin-top: 10px;
    }
</style>

{% endblock %}